---
title: "RefDB_Returns"
author: "BYDavis"
date: "2024-06-20"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

RMD to examine patterns and gaps between the input species list and the output 12S and COI reference databases.  , 

Load the files and packages to use:
```{r load}
splist <- readRDS("C:/Users/bydav/Desktop/SpeciesListCleaning_Complete/outputs/GNRMaineSpecies_May2024.RDS")

gonlylist <- readRDS("C:/Users/bydav/Desktop/SpeciesListCleaning_Complete/progression/GNRSpList_GenusOnly_May2024.RDS")

meta12S <- read.csv("C:/Users/bydav/Desktop/RefDB_Dev/output/2-May17-2024/12S_REFDB_metasum.csv", header = TRUE)

metaCOIfull <- read.csv("C:/Users/bydav/Desktop/RefDB_Dev/output/3-May19-2024/COI_REFDB_metasum.csv", header = TRUE)

library(ggplot2)
library(viridis)
library(dplyr)
```

In case I need to port to Excel for figs:
```{r}
splistout <- splist[c('superkingdom', 'kingdom', 'phylum', 'class', 'order', 'family', 'genus', 'species')]
meta12Sout <- meta12S[c('superkingdom', 'kingdom', 'phylum', 'class', 'order', 'family', 'genus', 'species', 'n_target', 'n_unique_seqs')]
metaCOIout <- metaCOI[c('superkingdom', 'kingdom', 'phylum', 'class', 'order', 'family', 'genus', 'species', 'n_target', 'n_unique_seqs')]
```



# What are the proportions of resolved species by Kingdom? Of Animalia/Metazoa specifically?

# How many resolved species had reference results for 12S in n_target? How spread out were the reference numbers?

# How many resolved species had reference results for COI? How spread out were the reference numbers?

# Are there differences in taxonomic coverage between 12S and COI returns? - Yes

Start small and get basic numbers
```{r}
# Remove species that didn't have any target sequences found
# For 12S
meta12 <- subset(meta12Sout, n_target != "0")
meta12 <- subset(meta12, n_target != "NA")

# For COI
metaCOI <- subset(metaCOIout, n_target != "0")
metaCOI <- subset(metaCOI, n_target != "NA")

# Count # of unique genuses and species in each refDB
un12sp <- unique(meta12$species) # 6454
un12g <- unique(meta12$genus) # 3735

unCOIsp <- unique(metaCOI$species) # 10355
unCOIg <- unique(metaCOI$genus) # 5437

# Grab species from each only
sp12 <- meta12[c('superkingdom', 'kingdom', 'phylum', 'class', 'order', 'family', 'genus', 'species')]
spCOI <- metaCOI[c('superkingdom', 'kingdom', 'phylum', 'class', 'order', 'family', 'genus', 'species')]
spCross <- dplyr::intersect(sp12, spCOI) # 3218 shared species

# What are the phyla of the shared species?
ggplot(spCross, aes(x = phylum, fill = kingdom)) +
  geom_bar() + coord_flip() + ggtitle("Number of Shared Species by Phylum") 
 

# What are the phyla of the sequence present refDBs?
ggplot(metaCOI, aes(x = phylum, fill = kingdom)) +
  geom_bar() + coord_flip() + ggtitle("Species by Phylum with COI References")

ggplot(meta12, aes(x = phylum, fill = kingdom)) +
  geom_bar() + coord_flip() + ggtitle("Species by Phylum with 12S References") 
```


What are the aggregate counts of numbers of species for the input list, meta12, and metaCOI?
```{r aggregate_counts}
# Splist for kingdom and superkingdom (since Bacteria is split between the two)
aggregate(splist$phylum, by = list(splist$phylum), FUN = length)
aggregate(splist$superkingdom, by = list(splist$superkingdom), FUN = length)
```
aggregate(splist$kingdom, by = list(splist$kingdom), FUN = length)
         Group.1     x
1                    1
2       Animalia   555
3       Bacteria    17
4      Chromista   223
5          Fungi  2194
6        Metazoa 10353
7             na  7756
8        Plantae   117
9       Protozoa     1
10 Viridiplantae  3790
aggregate(splist$superkingdom, by = list(splist$superkingdom), FUN = length)
    Group.1     x
1  Bacteria   514
2 Eukaryota 17213
3        na  7280


```{r aggregate_counts}
# Splist for kingdom and superkingdom (since Bacteria is split between the two)
aggregate(meta12$kingdom, by = list(meta12$kingdom), FUN = length)
aggregate(meta12$superkingdom, by = list(meta12$superkingdom), FUN = length)
```
 aggregate(meta12$kingdom, by = list(meta12$kingdom), FUN = length)
        Group.1    x
1      Animalia   11
2      Bacteria    1
3     Chromista    2
4         Fungi 1880
5       Metazoa 2901
6            na  936
7       Plantae   10
8 Viridiplantae 1179
 aggregate(meta12$superkingdom, by = list(meta12$superkingdom), FUN = length)
    Group.1    x
1  Bacteria   33
2 Eukaryota 6491
3        na  396

```{r aggregate_counts}
# Splist for kingdom and superkingdom (since Bacteria is split between the two)
aggregate(metaCOI$kingdom, by = list(metaCOI$kingdom), FUN = length)
aggregate(metaCOI$superkingdom, by = list(metaCOI$superkingdom), FUN = length)
```
 aggregate(metaCOI$kingdom, by = list(metaCOI$kingdom), FUN = length)
        Group.1    x
1      Animalia   39
2     Chromista    1
3         Fungi   90
4       Metazoa 9673
5            na  818
6       Plantae    3
7 Viridiplantae  309
 aggregate(metaCOI$superkingdom, by = list(metaCOI$superkingdom), FUN = length)
    Group.1     x
1  Bacteria     9
2 Eukaryota 10405
3        na   519

Remove all records except the Animalia and Metazoa from each list, then run phylum numbers
```{r}
meta_meta12 <- meta12[ which( meta12$kingdom == "Animalia" | meta12$kingdom == "Metazoa") , ]
meta_splist <- splist[ which( splist$kingdom == "Animalia" | splist$kingdom == "Metazoa") , ]
meta_metaCOI <- metaCOI[ which( metaCOI$kingdom == "Animalia" | metaCOI$kingdom == "Metazoa") , ]
```

Now repeat the count check for phylum
```{r aggregate_counts}
# Metazoan splist for phylum and class
meta_splist_phy <- aggregate(meta_splist$phylum, by = list(meta_splist$phylum), FUN = length)
meta_splist_class <- aggregate(meta_splist$class, by = list(meta_splist$class), FUN = length)
```


```{r aggregate_counts}
# Metazoan meta12 for phylum and class
meta_meta12_phy <- aggregate(meta_meta12$phylum, by = list(meta_meta12$phylum), FUN = length)
meta_meta12_class <- aggregate(meta_meta12$class, by = list(meta_meta12$class), FUN = length)
```


```{r aggregate_counts}
# Metazoan metaCOI for phylum and class
meta_metaCOI_phy <- aggregate(meta_metaCOI$phylum, by = list(meta_metaCOI$phylum), FUN = length)
meta_metaCOI_class <- aggregate(meta_metaCOI$class, by = list(meta_metaCOI$class), FUN = length)
```

Sequence counts

```{r}
# 12S by Kingdom
meta12S_seqsking <- aggregate(meta12$n_target, by = list(meta12$kingdom), FUN = sum)
# Metazoa only 12S by Phylum
meta_meta12S_seqsphy <- aggregate(meta_meta12$n_target, by = list(meta_meta12$phylum), FUN = sum)
# Metazoa only 12S by Class
meta_meta12S_seqsclass <- aggregate(meta_meta12$n_target, by = list(meta_meta12$class), FUN = sum)

# COI by Kingdom
metaCOI_seqsking <- aggregate(metaCOI$n_target, by = list(metaCOI$kingdom), FUN = sum)
# Metazoa only COI by Phylum
meta_metaCOI_seqsphy <- aggregate(meta_metaCOI$n_target, by = list(meta_metaCOI$phylum), FUN = sum)
# Metazoa only COI by Class
meta_metaCOI_seqsclass <- aggregate(meta_metaCOI$n_target, by = list(meta_metaCOI$class), FUN = sum)
```

Try to get sequence counts as proportions
```{r}
meta12S_seqsking$Prop <- (meta12S_seqsking$x/sum(meta12S_seqsking$x))
meta_meta12S_seqsphy$Prop <- (meta_meta12S_seqsphy$x/sum(meta_meta12S_seqsphy$x))
meta_meta12S_seqsclass$Prop <- (meta_meta12S_seqsclass$x/sum(meta_meta12S_seqsclass$x))

metaCOI_seqsking$Prop <- (metaCOI_seqsking$x/sum(metaCOI_seqsking$x))
meta_metaCOI_seqsphy$Prop <- (meta_metaCOI_seqsphy$x/sum(meta_metaCOI_seqsphy$x))
meta_metaCOI_seqsclass$Prop <- (meta_metaCOI_seqsclass$x/sum(meta_metaCOI_seqsclass$x))


# Bar Plot of Meta-only Meta12 Phyla (seq)
ggplot(meta_meta12S_seqsphy, aes(x = Group.1, y = Prop, fill = Group.1)) +
  geom_col()  + theme_bw() + geom_text(aes(label = x), vjust = -1, colour = "black") + labs(x = "Identified Phylum", y = "Proportion of Total Identified Sequences", title = "12S Reference Sequences, By Phylum", fill = "Phylum") +  theme(legend.position = "none") + theme(axis.text.x = element_text(angle=90, vjust=.5, hjust=1))


# Bar Plot of Meta-only MetaCOI Phyla (seq)
ggplot(meta_metaCOI_seqsphy, aes(x = Group.1, y = Prop, fill = Group.1)) +
  geom_col()  + theme_bw() + geom_text(aes(label = x), vjust = -1, colour = "black") + labs(x = "Identified Phylum", y = "Proportion of Total Identified Sequences", title = "COI Reference Sequences, By Phylum", fill = "Phylum") +  theme(legend.position = "none") + theme(axis.text.x = element_text(angle=90, vjust=.5, hjust=1))
```
